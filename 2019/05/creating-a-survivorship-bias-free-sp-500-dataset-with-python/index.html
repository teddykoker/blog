<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Creating a Survivorship Bias-Free S&amp;P 500 Dataset with Python | Teddy Koker</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Creating a Survivorship Bias-Free S&amp;P 500 Dataset with Python" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="When developing a stock trading strategy, it is important that the backtest be as accurate as possible. In some of my previous strategies, I have noted that the backtest did not account for survivorship bias. Survivorship bias is a form of selection bias caused by only focusing on assets that have already passed some sort of selection process." />
<meta property="og:description" content="When developing a stock trading strategy, it is important that the backtest be as accurate as possible. In some of my previous strategies, I have noted that the backtest did not account for survivorship bias. Survivorship bias is a form of selection bias caused by only focusing on assets that have already passed some sort of selection process." />
<link rel="canonical" href="https://teddykoker.com/2019/05/creating-a-survivorship-bias-free-sp-500-dataset-with-python/" />
<meta property="og:url" content="https://teddykoker.com/2019/05/creating-a-survivorship-bias-free-sp-500-dataset-with-python/" />
<meta property="og:site_name" content="Teddy Koker" />
<meta property="og:image" content="http://teddykoker.com/images/2019-05-12-creating-a-survivorship-bias-free-sp500-dataset-with-python_2_0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-05-12T00:00:00+00:00" />
<script type="application/ld+json">
{"headline":"Creating a Survivorship Bias-Free S&amp;P 500 Dataset with Python","dateModified":"2019-05-12T00:00:00+00:00","datePublished":"2019-05-12T00:00:00+00:00","description":"When developing a stock trading strategy, it is important that the backtest be as accurate as possible. In some of my previous strategies, I have noted that the backtest did not account for survivorship bias. Survivorship bias is a form of selection bias caused by only focusing on assets that have already passed some sort of selection process.","url":"https://teddykoker.com/2019/05/creating-a-survivorship-bias-free-sp-500-dataset-with-python/","mainEntityOfPage":{"@type":"WebPage","@id":"https://teddykoker.com/2019/05/creating-a-survivorship-bias-free-sp-500-dataset-with-python/"},"@type":"BlogPosting","image":"http://teddykoker.com/images/2019-05-12-creating-a-survivorship-bias-free-sp500-dataset-with-python_2_0.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/assets/trac.css"><link type="application/atom+xml" rel="alternate" href="https://teddykoker.com/feed.xml" title="Teddy Koker" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-138897125-1"></script>
<script>
  window['ga-disable-UA-138897125-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138897125-1');
</script>
<link rel="shortcut icon" href="/favicon.png">

  <!-- Katex Math (use defer to speed page load) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"
        integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq"
        crossorigin="anonymous">
  <script defer
          src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"
          integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz"
          crossorigin="anonymous"></script>
  <script defer
          src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"
          integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI"
          crossorigin="anonymous"
          onload='renderMathInElement(document.body,{delimiters: [{left: "\\[",
          right: "\\]", display: true}, {left: "$", right: "$", display: false}]})'></script>
</head>
</head>
<body>
<div class='content'><div class='nav'>
    <ul>
        <li><a href='/'>Teddy Koker</a></li>
        <li><a href='/writing'>Writing</a></li>
    </ul>
</div>
<h1>Creating a Survivorship Bias-Free S&P 500 Dataset with Python</h1>
<p>Published 2019-05-12</p>
<hr>
<p>When developing a stock trading strategy, it is important that the backtest be as accurate as possible. In some of my previous strategies, I have noted that the backtest did not account for survivorship bias. <a href="https://en.wikipedia.org/wiki/Survivorship_bias">Survivorship bias</a> is a form of selection bias caused by only focusing on assets that have already passed some sort of selection process.</p>

<p>A simple example would be a strategy that simply buys and holds an equal allocation of the current S&amp;P 500 constituents. We can use the S&amp;P 500 data from a <a href="/2019/04/backtesting-a-cross-sectional-mean-reversion-strategy-in-python">previous post</a>. We can then compare the performance of this strategy to that of RSP, an ETF that tracks the S&amp;P 500 Equal Weight Index:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">pandas_datareader.data</span> <span class="k">as</span> <span class="n">web</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">tickers</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'spy/tickers.csv'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># calculate cumulative product of the mean of all daily returns
# i.e. simulate growth of $1 by equally weighting all current S&amp;P 500
# constituents
</span><span class="n">sim_rsp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s">"spy/</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s">.csv"</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span>
            <span class="s">'close'</span>
        <span class="p">].</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="s">"SIM"</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># download actual RSP data
</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">web</span><span class="p">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s">"RSP"</span><span class="p">,</span> <span class="s">"yahoo"</span><span class="p">,</span> <span class="n">sim_rsp</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sim_rsp</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span>
        <span class="s">"Adj Close"</span>
    <span class="p">].</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.002</span> <span class="o">/</span> <span class="mi">252</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 0.20% annual ER
</span>    <span class="p">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="s">"RSP"</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">sim_rsp</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">"RSP vs. Survivorship-Biased Strategy"</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">rsp</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/images/2019-05-12-creating-a-survivorship-bias-free-sp500-dataset-with-python_2_0.png" alt="png" /></p>

<p>Wow! If we started trading this strategy in 2014 we would have easily beat the market. We only need to have known the constituents of the S&amp;P 500 5 years in the future… This simple example shows how a trader can be tricked into thinking they have a good strategy because they have not accounted for survivorship bias.</p>

<h1 id="survivorship-bias-free-data">Survivorship Bias-Free Data</h1>

<p>How do we prevent survivorship bias? It is easier said then done. In order to create a survivorship bias free data set of the S&amp;P 500, we have to first know all of the historical constituents of the S&amp;P 500 across our desired timeframe. Once we know all the constituents we can piece together a dataset using the historical price data of all the constituents during the time period they were in the S&amp;P 500.</p>

<p>Unfortunately their are a few road blocks that make this data collection more difficult than one might expect. First of all, obtaining historical constituent data for the S&amp;P 500 is hard. Current constituents can be scraped from <a href="https://en.wikipedia.org/wiki/List_of_S%26P_500_companies">Wikipedia</a>, but finding historical constituents is nearly impossible without purchasing data. Second, once you know the historical constituents, finding pricing data can be difficult as well. Companies in the S&amp;P 500 are periodically being renamed, being acquired, and some even going bankrupt. Free data sources like <a href="https://finance.yahoo.com/">Yahoo Finance</a> usually do not have data on de-listed stocks; historical ticker name changes are also not well documented.</p>

<h2 id="data-sources">Data Sources</h2>

<h3 id="constituents">Constituents</h3>

<p>While we don’t have real historical constituent data, we can make a close approximation using the portfolio of an S&amp;P 500 tracking ETF. The <a href="https://www.ishares.com/us/products/239726/">iShares Core S&amp;P 500 ETF (IVV)</a> discloses its holdings every month, and claims to invest at least 90% of its assets in securities in the index. With a little web scraping we can easily get its monthly holdings since 2006:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># request page
</span><span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://www.ishares.com/us/products/239726/#tabsAll"</span><span class="p">).</span><span class="n">content</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

<span class="c1"># find available dates
</span><span class="n">holdings</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"div"</span><span class="p">,</span> <span class="p">{</span><span class="s">"id"</span><span class="p">:</span> <span class="s">"holdings"</span><span class="p">})</span>
<span class="n">dates_div</span> <span class="o">=</span> <span class="n">holdings</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"div"</span><span class="p">,</span> <span class="s">"component-date-list"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">dates_div</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"option"</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">option</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">"value"</span><span class="p">]</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">dates_div</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"option"</span><span class="p">)]</span>

<span class="c1"># download constituents for each date
</span><span class="n">constituents</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">()</span>
<span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span>
        <span class="sa">f</span><span class="s">"https://www.ishares.com/us/products/239726/ishares-core-sp-500-etf/1467271812596.ajax?tab=all&amp;fileType=json&amp;asOfDate=</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s">"</span>
    <span class="p">).</span><span class="n">content</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="p">[(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">[</span><span class="s">'aaData'</span><span class="p">]]</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s">"%Y%m%d"</span><span class="p">)</span>
    <span class="n">constituents</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">tickers</span>

<span class="n">constituents</span> <span class="o">=</span> <span class="n">constituents</span><span class="p">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reverse into cronlogical order
</span><span class="n">constituents</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2006-09-29    [(PMCS, PMC-SIERRA INC.), (ANDW, ANDREW CORP.)...
2006-10-31    [(PMCS, PMC-SIERRA INC.), (PGL, PEOPLES ENERGY...
2006-11-30    [(PMCS, PMC-SIERRA INC.), (ADCT, ADC TELECOMMU...
2006-12-29    [(PMCS, PMC-SIERRA INC.), (ADCT, ADC TELECOMMU...
2007-01-31    [(PMCS, PMC-SIERRA INC.), (PGL, PEOPLES ENERGY...
dtype: object
</code></pre></div></div>

<p>As we can see for each month (only 5 shown) we have a list of all tickers and company names held in the ETF. Now that that’s done we can move on to the price data.</p>

<h3 id="price-data">Price Data</h3>

<p>As mentioned earlier, finding data for all of the constituents can be difficult. Lucky for us, Quandl’s <a href="https://www.quandl.com/databases/WIKIP/documentation">WIKI Prices Dataset</a> contains <em>most</em> of the data we need. Though the data feed is no longer updated, it still contains accurate data from before April 2018. We can export the data <a href="https://www.quandl.com/databases/WIKIP/usage/export">here</a> after creating a free account. After we download it we can separate the data by ticker symbol.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"WIKI_PRICES.csv"</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">wiki</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">wiki</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'ticker'</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">wiki</span><span class="p">:</span>
    <span class="n">wiki</span><span class="p">[</span><span class="n">ticker</span><span class="p">].</span><span class="n">set_index</span><span class="p">(</span><span class="s">"date"</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>Although the WIKI dataset has most of the data we need, it does not have all of it. We will use Yahoo finance to download the remaining data. Let’s write some helper functions to help us download the data:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">quandl_data</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">wiki</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">fix_ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">wiki</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">drop</span><span class="p">([</span><span class="s">'open'</span><span class="p">,</span><span class="s">'high'</span><span class="p">,</span><span class="s">'low'</span><span class="p">,</span><span class="s">'close'</span><span class="p">,</span> <span class="s">'volume'</span><span class="p">,</span><span class="s">'ex-dividend'</span><span class="p">,</span><span class="s">'split_ratio'</span><span class="p">,</span> <span class="s">'ticker'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">"adj_open"</span><span class="p">:</span> <span class="s">"open"</span><span class="p">,</span>
                                       <span class="s">"adj_high"</span><span class="p">:</span> <span class="s">"high"</span><span class="p">,</span>
                                       <span class="s">"adj_low"</span><span class="p">:</span> <span class="s">"low"</span><span class="p">,</span>
                                       <span class="s">"adj_close"</span><span class="p">:</span> <span class="s">"close"</span><span class="p">,</span>
                                       <span class="s">"adj_volume"</span><span class="p">:</span> <span class="s">"volume"</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">yahoo_data</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">fix_ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">web</span><span class="p">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="s">"yahoo"</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">web</span><span class="p">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="s">"yahoo"</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c1"># adjust ohlc using adj close
</span>    <span class="n">adjfactor</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"Close"</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s">"Adj Close"</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"Open"</span><span class="p">]</span> <span class="o">/=</span> <span class="n">adjfactor</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"High"</span><span class="p">]</span> <span class="o">/=</span> <span class="n">adjfactor</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"Low"</span><span class="p">]</span> <span class="o">/=</span> <span class="n">adjfactor</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"Close"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"Adj Close"</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"Volume"</span><span class="p">]</span> <span class="o">*=</span> <span class="n">adjfactor</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">drop</span><span class="p">([</span><span class="s">"Adj Close"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="nb">str</span><span class="p">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s">'columns'</span><span class="p">)</span>
    <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="s">'date'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">fix_ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">):</span>
    <span class="n">rename_table</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"-"</span><span class="p">:</span> <span class="s">"LPRAX"</span><span class="p">,</span> <span class="c1"># BlackRock LifePath Dynamic Retirement Fund
</span>        <span class="s">"8686"</span><span class="p">:</span> <span class="s">"AFL"</span><span class="p">,</span> <span class="c1"># AFLAC
</span>        <span class="s">"4XS"</span><span class="p">:</span> <span class="s">"ESRX"</span><span class="p">,</span> <span class="c1"># Express Scripts Holding Company 
</span>        <span class="s">"AAZ"</span><span class="p">:</span> <span class="s">"APC"</span><span class="p">,</span> <span class="c1"># Anadarko Petroleum Corporation
</span>        <span class="s">"AG4"</span><span class="p">:</span> <span class="s">"AGN"</span><span class="p">,</span> <span class="c1"># Allergan plc
</span>        <span class="s">"BFB"</span><span class="p">:</span> <span class="s">"BF_B"</span><span class="p">,</span> <span class="c1"># Brown-Forman Corporation
</span>        <span class="s">"BF.B"</span><span class="p">:</span> <span class="s">"BF_B"</span><span class="p">,</span> <span class="c1"># Brown-Forman Corporation
</span>        <span class="s">"BF/B"</span><span class="p">:</span> <span class="s">"BF_B"</span><span class="p">,</span> <span class="c1"># Brown-Forman Corporation
</span>        <span class="s">"BLD WI"</span><span class="p">:</span> <span class="s">"BLD"</span><span class="p">,</span> <span class="c1"># TopBuild Corp.
</span>        <span class="s">"BRKB"</span><span class="p">:</span> <span class="s">"BRK_B"</span><span class="p">,</span> <span class="c1"># Berkshire Hathaway Inc.
</span>        <span class="s">"CC WI"</span><span class="p">:</span> <span class="s">"CC"</span><span class="p">,</span> <span class="c1"># The Chemours Company
</span>        <span class="s">"DC7"</span><span class="p">:</span> <span class="s">"DFS"</span><span class="p">,</span> <span class="c1"># Discover Financial Services
</span>        <span class="s">"GGQ7"</span><span class="p">:</span> <span class="s">"GOOG"</span><span class="p">,</span> <span class="c1"># Alphabet Inc. Class C
</span>        <span class="s">"HNZ"</span><span class="p">:</span> <span class="s">"KHC"</span><span class="p">,</span> <span class="c1"># The Kraft Heinz Company
</span>        <span class="s">"LOM"</span><span class="p">:</span> <span class="s">"LMT"</span><span class="p">,</span> <span class="c1"># Lockheed Martin Corp.
</span>        <span class="s">"LTD"</span><span class="p">:</span> <span class="s">"LB"</span><span class="p">,</span> <span class="c1"># L Brands Inc.
</span>        <span class="s">"LTR"</span><span class="p">:</span> <span class="s">"L"</span><span class="p">,</span> <span class="c1"># Loews Corporation
</span>        <span class="s">"MPN"</span><span class="p">:</span> <span class="s">"MPC"</span><span class="p">,</span> <span class="c1"># Marathon Petroleum Corp.
</span>        <span class="s">"MWZ"</span><span class="p">:</span> <span class="s">"MET"</span><span class="p">,</span> <span class="c1"># Metlife Inc.
</span>        <span class="s">"MX4A"</span><span class="p">:</span> <span class="s">"CME"</span><span class="p">,</span> <span class="c1"># CME Group Inc.
</span>        <span class="s">"NCRA"</span><span class="p">:</span> <span class="s">"NWSA"</span><span class="p">,</span> <span class="c1"># News Corporation
</span>        <span class="s">"NTH"</span><span class="p">:</span> <span class="s">"NOC"</span><span class="p">,</span> <span class="c1"># Northrop Grumman Crop.
</span>        <span class="s">"PA9"</span><span class="p">:</span> <span class="s">"TRV"</span><span class="p">,</span> <span class="c1"># The Travelers Companies, Inc.
</span>        <span class="s">"QCI"</span><span class="p">:</span> <span class="s">"QCOM"</span><span class="p">,</span> <span class="c1"># Qualcomm Inc.
</span>        <span class="s">"RN7"</span><span class="p">:</span> <span class="s">"RF"</span><span class="p">,</span> <span class="c1"># Regions Financial Corp
</span>        <span class="s">"SLBA"</span><span class="p">:</span> <span class="s">"SLB"</span><span class="p">,</span> <span class="c1"># Schlumberger Limited
</span>        <span class="s">"SYF-W"</span><span class="p">:</span> <span class="s">"SYF"</span><span class="p">,</span> <span class="c1"># Synchrony Financial
</span>        <span class="s">"SWG"</span><span class="p">:</span> <span class="s">"SCHW"</span><span class="p">,</span> <span class="c1"># The Charles Schwab Corporation 
</span>        <span class="s">"UAC/C"</span><span class="p">:</span> <span class="s">"UAA"</span><span class="p">,</span> <span class="c1"># Under Armour Inc Class A
</span>        <span class="s">"UBSFT"</span><span class="p">:</span> <span class="s">"UBSFY"</span><span class="p">,</span> <span class="c1"># Ubisoft Entertainment
</span>        <span class="s">"USX1"</span><span class="p">:</span> <span class="s">"X"</span><span class="p">,</span> <span class="c1"># United States Steel Corporation
</span>        <span class="s">"UUM"</span><span class="p">:</span> <span class="s">"UNM"</span><span class="p">,</span> <span class="c1"># Unum Group
</span>        <span class="s">"VISA"</span><span class="p">:</span> <span class="s">"V"</span><span class="p">,</span> <span class="c1"># Visa Inc 
</span>    <span class="p">}</span>
    <span class="k">if</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">rename_table</span><span class="p">:</span>
        <span class="n">fix</span> <span class="o">=</span> <span class="n">rename_table</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fix</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">'[^A-Z]+'</span><span class="p">,</span> <span class="s">''</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fix</span>
</code></pre></div></div>

<p>You’ll notice I created a big dictionary <code class="highlighter-rouge">rename_table</code>. As mentioned before, companies will occasionally change their ticker symbols, and it is often not well documented. I ended up manually creating this map of old to new ticker symbol, which does add a component of human error.</p>

<h2 id="compiling-data">Compiling Data</h2>

<p>Now we are ready to compile all the data using our constituents list! We will also keep track of stocks with missing data in <code class="highlighter-rouge">skips</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">skips</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="n">constituents</span> <span class="o">=</span> <span class="n">constituents</span><span class="p">[</span><span class="s">'2013-02-28'</span><span class="p">:</span><span class="s">'2018-02-28'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">constituents</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">constituents</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">date</span><span class="p">())</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">constituents</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">to_pydatetime</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)).</span><span class="n">date</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">constituents</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">skips</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">quandl_data</span><span class="p">(</span><span class="n">company</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">yahoo_data</span><span class="p">(</span><span class="n">company</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">skips</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">company</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">company</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">company</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">company</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span>
</code></pre></div></div>

<p>Let’s take a look at the data we had to skip:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">skips</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{('ACT', 'ACTAVIS INC.'),
 ('ACT', 'ACTAVIS PLC'),
 ('BLKFDS', 'BLK CSH FND TREASURY SL AGENCY'),
 ('BMC', 'BMC SOFTWARE INC.'),
 ('CVH', 'COVENTRY HEALTH CARE INC'),
 ('ESH5', 'S&amp;P500 EMINI MAR 15'),
 ('ESH6', 'S&amp;P500 EMINI MAR 16'),
 ('ESH7', 'S&amp;P500 EMINI MAR 17'),
 ('ESH8', 'S&amp;P500 EMINI MAR 18'),
 ('ESM5', 'S&amp;P500 EMINI JUN 15'),
 ('ESM6', 'S&amp;P500 EMINI JUN 16'),
 ('ESM7', 'S&amp;P500 EMINI JUN 17'),
 ('ESU5', 'S&amp;P500 EMINI SEP 15'),
 ('ESU6', 'S&amp;P500 EMINI SEP 16'),
 ('ESU7', 'S&amp;P500 EMINI SEP 17'),
 ('ESZ4', 'S&amp;P500 EMINI DEC 14'),
 ('ESZ5', 'S&amp;P500 EMINI DEC 15'),
 ('ESZ6', 'S&amp;P500 EMINI DEC 16'),
 ('ESZ7', 'S&amp;P500 EMINI DEC 17'),
 ('HAWKB', 'BLACKHAWK NETWORK HOLDINGS INC CLA'),
 ('MARGIN_USD', 'FUTURES USD MARGIN BALANCE'),
 ('MOLX', 'MOLEX INC.'),
 ('NYX', 'NYSE EURONEXT'),
 ('PCS', 'METROPCS COMMUNICATIONS INC.'),
 ('UBFUT', 'CASH COLLATERAL USD UBFUT')}
</code></pre></div></div>

<p>As we can see there are a few companies that we could not get data for because they have since been acquired. It may be possible find the data from a different source, but let’s keep what we have so far. In addition, we notice that the ETF occasionally held S&amp;P 500 futures as well as cash collateral, which is part of the &lt;10% of holdings not in the index.</p>

<h2 id="exporting">Exporting</h2>

<p>Now we can export our data back into csv:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">reset_index</span><span class="p">().</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s">'date'</span><span class="p">).</span><span class="n">set_index</span><span class="p">(</span><span class="s">'date'</span><span class="p">)</span>
    <span class="n">df</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s">"survivorship-free/</span><span class="si">{</span><span class="n">fix_ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span><span class="si">}</span><span class="s">.csv"</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">fix_ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span> <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="n">keys</span><span class="p">()]</span>
<span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tickers</span><span class="p">).</span><span class="n">to_csv</span><span class="p">(</span><span class="s">"survivorship-free/tickers.csv"</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="testing">Testing</h1>

<p>Now that we have our survivorship bias free data, lets test it against the equal weight S&amp;P 500 ETF RSP used in the first section:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sim_rsp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s">"survivorship-free/</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s">.csv"</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span>
            <span class="s">'close'</span>
        <span class="p">].</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="s">"SIM"</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">web</span><span class="p">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s">"RSP"</span><span class="p">,</span> <span class="s">"yahoo"</span><span class="p">,</span> <span class="n">sim_rsp</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sim_rsp</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span>
        <span class="s">"Adj Close"</span>
    <span class="p">].</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.002</span> <span class="o">/</span> <span class="mi">252</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 0.20% annual ER
</span>    <span class="p">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="s">"RSP"</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">sim_rsp</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">"RSP vs. Un-Survivorship-Biased Strategy"</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">rsp</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/images/2019-05-12-creating-a-survivorship-bias-free-sp500-dataset-with-python_29_0.png" alt="png" /></p>

<p>The lines are nearly identical! Although my dataset is not 100% historically accurate, it is definitely a much better start than just using current S&amp;P 500 constituents. Best of all, it only uses free data, and you can download it from my <a href="https://github.com/teddykoker/quant/tree/master/survivorship-free">Github</a>. Now that we have a survivorship bias-free dataset, we can backtest future strategies with greater accuracy.</p>

<hr>
<ol class="bibliography"></ol>

</div>
</body>
</html>
