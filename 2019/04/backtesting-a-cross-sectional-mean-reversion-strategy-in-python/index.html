<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Backtesting a Cross-Sectional Mean Reversion Strategy in Python | Teddy Koker</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Backtesting a Cross-Sectional Mean Reversion Strategy in Python" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this post we will look at a cross-sectional mean reversion strategy from Ernest Chan’s book Algorithmic Trading: Winning Strategies and Their Rationale and backtest its performance using Backtrader." />
<meta property="og:description" content="In this post we will look at a cross-sectional mean reversion strategy from Ernest Chan’s book Algorithmic Trading: Winning Strategies and Their Rationale and backtest its performance using Backtrader." />
<link rel="canonical" href="https://teddykoker.com/2019/04/backtesting-a-cross-sectional-mean-reversion-strategy-in-python/" />
<meta property="og:url" content="https://teddykoker.com/2019/04/backtesting-a-cross-sectional-mean-reversion-strategy-in-python/" />
<meta property="og:site_name" content="Teddy Koker" />
<meta property="og:image" content="http://teddykoker.com/images/2019-04-28-backtesting-a-cross-sectional-mean-reversion-strategy-in-python_18_1.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-28T00:00:00+00:00" />
<script type="application/ld+json">
{"headline":"Backtesting a Cross-Sectional Mean Reversion Strategy in Python","dateModified":"2019-04-28T00:00:00+00:00","datePublished":"2019-04-28T00:00:00+00:00","description":"In this post we will look at a cross-sectional mean reversion strategy from Ernest Chan’s book Algorithmic Trading: Winning Strategies and Their Rationale and backtest its performance using Backtrader.","url":"https://teddykoker.com/2019/04/backtesting-a-cross-sectional-mean-reversion-strategy-in-python/","mainEntityOfPage":{"@type":"WebPage","@id":"https://teddykoker.com/2019/04/backtesting-a-cross-sectional-mean-reversion-strategy-in-python/"},"@type":"BlogPosting","image":"http://teddykoker.com/images/2019-04-28-backtesting-a-cross-sectional-mean-reversion-strategy-in-python_18_1.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/assets/trac.css"><link type="application/atom+xml" rel="alternate" href="https://teddykoker.com/feed.xml" title="Teddy Koker" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-138897125-1"></script>
<script>
  window['ga-disable-UA-138897125-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138897125-1');
</script>
<link rel="shortcut icon" href="/favicon.png">

  <!-- Katex Math (use defer to speed page load) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"
        integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq"
        crossorigin="anonymous">
  <script defer
          src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"
          integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz"
          crossorigin="anonymous"></script>
  <script defer
          src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"
          integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI"
          crossorigin="anonymous"
          onload='renderMathInElement(document.body,{delimiters: [{left: "\\[",
          right: "\\]", display: true}, {left: "$", right: "$", display: false}]})'></script>
</head>
</head>
<body>
<div class='content'><div class='nav'>
    <ul>
        <li><a href='/'>Teddy Koker</a></li>
        <li><a href='/writing'>Writing</a></li>
    </ul>
</div>
<h1>Backtesting a Cross-Sectional Mean Reversion Strategy in Python</h1>
<p>Published 2019-04-28</p>
<hr>
<p>In this post we will look at a cross-sectional mean reversion strategy from Ernest Chan’s book <a href="https://amzn.to/2VptDjd">Algorithmic Trading: Winning Strategies and Their Rationale</a> and backtest its performance using <a href="https://www.backtrader.com/">Backtrader</a>.</p>

<p>Typically, a cross-sectional mean reversion strategy is fed a universe of stocks, where each stock has its own relative returns compared to the mean returns of the universe. A stock with a <em>positive</em> relative return is <em>shorted</em> while a stock with a <em>negative</em> relative return is <em>bought</em>, in hopes that a stock that under or outperformed the universe will soon revert to the mean of the universe.</p>

<p>The strategy described in Chan’s book is as follows: Everyday, every stock $i$ in the universe is assigned a weight $w_i$ according to the following formula:</p>

\[w_i = -(r_i - r_m) / \sum_k | r_k - r_m |\]

<p>Where $r_m$ is the mean returns of the universe. This weight will tell us how much of the portfolio will be long or short that particular stock. As we can see in the formula, the farther an individual stock’s returns are from the mean, the greater its weight will be.</p>

<h2 id="collecting-data">Collecting Data</h2>

<p>In order to test this strategy, we will need to select a universe of stocks. In this case we will use the S&amp;P 500. So we don’t have to re-download the data between backtests, lets download daily data for all the tickers in the S&amp;P 500. We’ll start by reading in the list of tickers from <a href="https://en.wikipedia.org/wiki/List_of_S%26P_500_companies">Wikipedia</a>, and save them to a file <code class="highlighter-rouge">spy/tickers.csv</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">pandas_datareader.data</span> <span class="k">as</span> <span class="n">web</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="k">as</span> <span class="n">bt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> 

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_html</span><span class="p">(</span><span class="s">'https://en.wikipedia.org/wiki/List_of_S%26P_500_companies'</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">].</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tickers</span><span class="p">).</span><span class="n">to_csv</span><span class="p">(</span><span class="s">"spy/tickers.csv"</span><span class="p">)</span>
</code></pre></div></div>

<p>Now that we have a the list of tickers, we can download all of the data from the past 5 years. We will use <code class="highlighter-rouge">concurrent.futures.ThreadPoolExecutor</code> to speed up the task.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span> 

<span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> 
<span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">end</span><span class="p">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">end</span><span class="p">.</span><span class="n">month</span> <span class="p">,</span> <span class="n">end</span><span class="p">.</span><span class="n">day</span><span class="p">)</span>
<span class="n">bad</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">ticker</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">web</span><span class="p">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span><span class="s">'iex'</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="n">df</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s">"spy/</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s">.csv"</span><span class="p">)</span>

<span class="k">with</span> <span class="n">futures</span><span class="p">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span> 
    <span class="n">res</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">download</span><span class="p">,</span> <span class="n">tickers</span><span class="p">)</span> 

</code></pre></div></div>

<p>Now we should have all our data in the <code class="highlighter-rouge">spy</code> directory! Now we can get to writing the strategy.</p>

<h2 id="strategy">Strategy</h2>

<p>Here is the full strategy using the above formula.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CrossSectionalMR</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prenext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">next</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># only look at data that existed yesterday
</span>        <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="bp">self</span><span class="p">.</span><span class="n">datas</span><span class="p">))</span> 
        
        <span class="n">rets</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">available</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">available</span><span class="p">):</span>
            <span class="c1"># calculate individual daily returns
</span>            <span class="n">rets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span> <span class="n">d</span><span class="p">.</span><span class="n">close</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">d</span><span class="p">.</span><span class="n">close</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># calculate weights using formula
</span>        <span class="n">market_ret</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rets</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">rets</span> <span class="o">-</span> <span class="n">market_ret</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">available</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">order_target_percent</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>

<p>Note: It is worth mentioning that Backtrader only calls a strategy’s <code class="highlighter-rouge">next()</code> method when it has a price tick from every data feed. This means that by default the strategy will not trade if, for example, a company in the universe has not started trading publicly yet. We can circumvent this issue by calling <code class="highlighter-rouge">next()</code> in <code class="highlighter-rouge">prenext()</code> and then applying the weight calculation formula to only stocks in which we have data to.</p>

<h2 id="backtesting">Backtesting</h2>

<p>We’re ready to backtest! Lets see how this strategy works with an initial capital of $1,000,000.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">Cerebro</span><span class="p">(</span><span class="n">stdstats</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">cerebro</span><span class="p">.</span><span class="n">broker</span><span class="p">.</span><span class="n">set_coc</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">feeds</span><span class="p">.</span><span class="n">GenericCSVData</span><span class="p">(</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
        <span class="n">dataname</span><span class="o">=</span><span class="sa">f</span><span class="s">"spy/</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s">.csv"</span><span class="p">,</span>
        <span class="n">dtformat</span><span class="o">=</span><span class="p">(</span><span class="s">'%Y-%m-%d'</span><span class="p">),</span>
        <span class="n">openinterest</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">nullvalue</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>
    <span class="n">cerebro</span><span class="p">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">cerebro</span><span class="p">.</span><span class="n">broker</span><span class="p">.</span><span class="n">setcash</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span>
<span class="n">cerebro</span><span class="p">.</span><span class="n">addobserver</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">observers</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
<span class="n">cerebro</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">SharpeRatio</span><span class="p">,</span> <span class="n">riskfreerate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">cerebro</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">Returns</span><span class="p">)</span>
<span class="n">cerebro</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">DrawDown</span><span class="p">)</span>
<span class="n">cerebro</span><span class="p">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">CrossSectionalMR</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">cerebro</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Sharpe: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">sharperatio</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'sharperatio'</span><span class="p">]:.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Norm. Annual Return: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'rnorm100'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Max Drawdown: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">drawdown</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'max'</span><span class="p">][</span><span class="s">'drawdown'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%"</span><span class="p">)</span>
<span class="n">cerebro</span><span class="p">.</span><span class="n">plot</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sharpe: 1.173
Norm. Annual Return: 7.98%
Max Drawdown: 6.58%
</code></pre></div></div>

<p><img src="/images/2019-04-28-backtesting-a-cross-sectional-mean-reversion-strategy-in-python_18_1.png" alt="png" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>As we can see the algorithm did fairly well! It had a Sharpe ratio of 1.17 with a normalized annual return of 7.9%. Although the returns might not be much better then buying and holding SPY, the volatility is greatly reduced. We do, however, have to take a few things into consideration:</p>

<ol>
  <li>
    <p>The dataset we are using may have a slight survivorship bias as it does not contain companies who where in the S&amp;P 500 5 years ago, but have since been removed.</p>
  </li>
  <li>
    <p>The above backtest assumes that it will compute weights at market close then be able to trade at the exact market close price. In reality we wouldn’t be able to compute weights with the exact close price, but it would be pretty close.</p>
  </li>
  <li>
    <p>Since this particular algorithm trades every stock in the universe at once, the investor will need a large amount of capitol to accurately match the computed weights.</p>
  </li>
</ol>

<hr>
<ol class="bibliography"></ol>

</div>
</body>
</html>
